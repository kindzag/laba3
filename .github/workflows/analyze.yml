name: Repository Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
    - cron: '0 0 * * *'

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–æ–≤
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Run repository analysis
      run: |
        python analyze_repo.py --output report.log --json
    
    - name: Create summary
      run: |
        echo "## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f report.log ]; then
          echo "–û—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -20 report.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå –û—Ç—á—ë—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Commit and push report
      run: |
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git add report.log report.json
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        if ! git diff --cached --quiet; then
          # –ï—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è - —Å–æ–∑–¥–∞—ë–º –∫–æ–º–º–∏—Ç
          git commit -m "üìä Auto-generated repository analysis report"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push
          echo "‚úÖ –û—Ç—á—ë—Ç –∑–∞–∫–æ–º–º–∏—á–µ–Ω –∏ –∑–∞–ø—É—à–µ–Ω"
        else
          echo "‚ÑπÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –∫–æ–º–º–∏—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
        fi
    
    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: analysis-report
        path: |
          report.log
          report.json
